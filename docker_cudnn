#FROM python:3.9.4-buster
FROM nvidia/cuda:9.2-cudnn7-devel-ubuntu18.04

RUN apt-get update
RUN apt-get -y install curl wget
RUN apt-get -y install libgraphicsmagick++1-dev libsuitesparse-dev libqrupdate1 libfftw3-3 libhdf5-100 libgl1 libglu1-mesa libgl2ps1.4 \
        libcurl4-gnutls-dev libarpack2 libopenblas-base

#RUN pip3 install oct2py

RUN mkdir /content

WORKDIR /content

RUN LOCATION=$(curl -s https://api.github.com/repos/cerr/octave-colab/releases/latest \
| awk -F\" '/browser_download_url/ { print $4 }') && curl -L -o octavecolab.tar.gz $LOCATION


ENV OCTAVE_TOP=octave6.2.0
ENV OCTAVE_EXECUTABLE=/content/$OCTAVE_TOP/bin/octave-cli
ENV PATH=/content/$OCTAVE_TOP/bin/:$PATH

RUN tar xvf octavecolab.tar.gz

RUN wget https://nchc.dl.sourceforge.net/project/octave/Octave%20Forge%20Packages/Individual%20Package%20Releases/image-2.12.0.tar.gz && \
    wget https://nchc.dl.sourceforge.net/project/octave/Octave%20Forge%20Packages/Individual%20Package%20Releases/io-2.6.1.tar.gz  && \
    wget https://nchc.dl.sourceforge.net/project/octave/Octave%20Forge%20Packages/Individual%20Package%20Releases/statistics-1.4.2.tar.gz

RUN octave --eval "pkg install io-2.6.1.tar.gz" && \
    octave --eval "pkg install image-2.12.0.tar.gz" && \
    octave --eval "pkg install statistics-1.4.2.tar.gz"

RUN rm *.tar.gz

RUN apt-get install -y git && git clone https://github.com/cerr/CERR.git && cd ./CERR && git checkout octave_dev && cd /

# Copy analysis/function scripts to /ana
RUN mkdir /ana
COPY radiomic_and_dosimetric_feature_extraction.m /ana/radiomic_and_dosimetric_feature_extraction.m
COPY run_cerr.py /ana/run_cerr.py

RUN mkdir /software /build
ADD CT_Lung_incrMRRN/environment.yml /build
ADD CT_Lung_incrMRRN/model /software/model
ADD CT_Lung_incrMRRN/model_wrapper /software/model_wrapper

RUN wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /build/Miniconda3-latest-Linux-x86_64.sh && \
        bash /build/Miniconda3-latest-Linux-x86_64.sh -b -p /miniconda3

ENV PATH=/miniconda3/bin:/miniconda3/condabin:${PATH}
ENV PYTHONPATH=/software/model_wrapper:/miniconda3/bin

RUN conda init && conda update -n base -c defaults conda && conda env create -f /build/environment.yml
RUN pip install oct2py && pip install octave_kernel
RUN apt-get -y install gnuplot

RUN mkdir /scratch

#ENTRYPOINT [ "python3", "/ana/run_cerr.py" ]
